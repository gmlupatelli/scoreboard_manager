# Netlify Configuration
# https://docs.netlify.com/configure-builds/file-based-configuration/

[build]
  command = "npm run build:prod"
  publish = ".next"

[build.environment]
  # Node version for compatibility
  NODE_VERSION = "20"

# Install Supabase CLI before build
[[plugins]]
  package = "@netlify/plugin-nextjs"

# Lighthouse performance monitoring
[[plugins]]
  package = "@netlify/plugin-lighthouse"

  [plugins.inputs.thresholds]
    performance = 0.9
    accessibility = 0.9
    best-practices = 0.9
    seo = 0.9

# Custom build lifecycle hook to install Supabase CLI
[build.processing]
  skip_processing = false

# Production settings - runs migrations before build using npm-based Supabase CLI
# Uses locally installed supabase from package.json (pinned version) for security
[context.production]
  command = "npx supabase link --project-ref \"$SUPABASE_PROJECT_REF\" && npx supabase db push && npm run build"
  
[context.production.environment]
  NEXT_PUBLIC_SITE_URL = "https://myscoreboardmanager.netlify.app"

# Dev branch settings (uses dev Supabase project - migrations applied manually)
[context.dev]
  command = "npm run build"
  
[context.dev.environment]
  NEXT_PUBLIC_SITE_URL = "https://dev--myscoreboardmanager.netlify.app"

# Deploy preview settings (no migrations)
[context.deploy-preview]
  command = "npm run build"

# Branch deploy settings (no migrations)
[context.branch-deploy]
  command = "npm run build"
